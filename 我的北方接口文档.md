# 我的北方接口文档
[TOC]
## 接口标准
参考[RESTful API 设计指南](http://www.ruanyifeng.com/blog/2014/05/restful_api.html)。
### 设计理念及原则
接口尽可能满足Restful的设计理念。 每一个接口代表一种资源，以名词表示。对资源的操作（动词，即增删改查/CURD）由HTTP 1.1中的`GET`（查询/retrieve）、`POST`（新建/create）、`PUT`（更新/update）和`DELETE`（删除/delete）四种方法来表示。 接口路径中含有多个单词时请使用连字符`-`。获取资源时需要过滤则参考对应接口下可供筛选的字段构建请求。
### 请求
#### 身份认证
大部分接口都需要*身份认证*，在`Request Headers`中增加`Token`字段，每个用户在一段时间之内与唯一一个`Token`对应。

测试服永久`Token`：`001tiITq09tJFl10qATq0jb0Uq0tiITD`

这个`Token`不受**MongoDB**`TTL`索引影响。关于`TTL`索引请[参考此处](http://www.mongoing.com/docs/core/index-ttl.html)。

请求需要身份认证的接口时必须携带有效的`Token`否则服务器将返回`401`。
`Token`过期之后应重新请求登陆接口获取新的`Token`。
**不需要认证的接口将使用“🌏”标明，需要认证的接口用“🔑”标明。**

#### 请求参数传递
* **GET**
队列参数，例：`/v1/test?id=001&name=tom`
* **POST**
form-data
* **PUT**
form-data
* **DELETE**
队列参数

⚠️后文中的所有接口的参数将通过表格的形式展示，实际传参不再赘述。

#### 接口路由

以2级标题注明接口名称和路径，形如：

<img src="https://tva1.sinaimg.cn/large/006tNbRwly1ga59fj352xj30ms04q74s.jpg" alt="image-20191222095002473" style="zoom:33%;" />

对于携带参数的可变路由，形如：

<img src="https://tva1.sinaimg.cn/large/006tNbRwly1ga59k9n5whj30qe04474k.jpg" alt="image-20191222095437892" style="zoom:33%;" />

其中尖括号括起的就是可变参数。

每个接口接受若干种请求方法，每个请求方法以3级标题注明，形如：

<img src="https://tva1.sinaimg.cn/large/006tNbRwly1ga59ouufr2j30d603474f.jpg" alt="image-20191222095902438" style="zoom:33%;" />

### 响应
⚠️HTTP响应状态码除服务器错误为`500`之外统一为`200`，正式版本理论上不应该出现`500`错误。
除特殊资源外统一使用`json`数据格式，一个标准的响应数据如下：

```json
{
    "code":401,
    "m":"身份认证失败",
    "data":{}
}
```
其中`code`为响应的状态码，以下是所有接口通用的状态码及其含义：

* `200` OK
  	请求成功。
  
* `401`  Unauthorized
  	需要身份认证。请求需要认证的接口但没有携带`Token`或`Token`已经过期的情况下会返回`401`，客户端应该对这种状态码进行统一封装处理。
  
* `404` Not Found
没有请求的资源。
  

请求正常完成均会返回`200`，此时可以访问`data`字段获取需要的数据，`data`可能是对象或列表。

 `code`非`200`是异常情况，在`m`字段中会返回错误的原因，客户端根据需要可以直接显示给用户。

每个接口可能有自己定义的错误代码。

## 数据定义
### UserInfo

用户信息

```json
{
    "sno": "17152010921",
    "sex": "男",
  	"nickName":"BBfat",
    "avatarUrl": "...",
    "name": "鞠欣诚",
    "openid": "o1Glo5BZgdDoVqkuXgKzSw_r4T_M",
    "class": "经管17",
    "college": "经济管理学院",
    "source": "山西省"
}
```

### Course

课程信息

```json
{
    "course_name": "数据库原理",
    "course_code": "2019_A_7234801_2019A510025",
    "teacher_name": "",
    "role": "student",
    "course_class": "计17-123;计专起本19"
}
```

### Courseware

课件信息

```json
{
    "url": "http://iclass.ncut.edu.cn/iclass/netclass/backends/download_api.php?url=L8r9vt2%2F4tStwO0tLcq10enWuLW8yumjqDIwMTnE6sfvvL6jqS5uZXSw5rG%2BLmRvYw%3D%3D&cidReset=true&cidReq=2019_A_7234801_2019A510025",
    "type": "file",
    "size": 1751040,
    "date": "2019-11-29",
    "course_code": "2019_A_7234801_2019A510025",
    "filename": "数据库原理--实验指导书（2019年秋季）.net版本.doc",
  	"_id": "5e02cea797c32ce21d820563"
}
```

`Courseware`不单独开集合存储，仅以内嵌文档的方式存放在需要的地方。

## 🌍身份认证：`/v1/auth`

### `POST`签发Token

| 参数名称 | 参数类型 | 备注             |
| -------- | -------- | ---------------- |
| code     | String   | 微信临时登陆凭证 |

`code`是通过小程序的`wx.login()`函数生成的临时登陆码，参考：[wx.login()文档](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html) [小程序登陆](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html)
小程序服务器会和微信服务器通信并获取该用户的`openid`。

#### 授权用户签发

```json
{
    "code":200,
    "m":"",
    "data":{
        "Token":"qwerty"
    }
}
```

#### 非授权用户拒绝签发

```json
{
    "code":401,
    "m":"Unauthorized",
    "data":null
}
```

此时客户端应该捕获这个异常，拉起企业号OAuth登陆页面，尝试授权，授权成功之后客户端再次请求签发`Token`就会成功。

判断一个用户是否是授权用户的条件是：**数据库中有没有该openid对应的用户信息。**

关于注册相关的内容由于和接口无关，将在另一篇文档中详细讨论。

## 🌍Banner：`/v1/banner`

### `GET`获取信息

返回首页的Banner和Notice的数据，*这个接口设计有可能更改*。

```json
{
    "code": 200,
    "m": "",
    "data": {
        "indexBanner": [
            {
                "index": 0,
                "msgurl": "https://mp.weixin.qq.com/s/ajKyJpTMa-mi5WiNbZ2s3A",
                "imgurl": "https://myncut.oss-cn-beijing.aliyuncs.com/Banner/封面.jpg?x-oss-process=image/auto-orient,1/quality,q_70"
            },
            {
                "index": 1,
                "msgurl": "https://mp.weixin.qq.com/s/2QGJhSZacjwseBME-xXbKw",
                "imgurl": "https://myncut.oss-cn-beijing.aliyuncs.com/Banner/1618e1b390bff8efc395356559ca5ed.jpg?x-oss-process=image/auto-orient,1/quality,q_70"
            },
            {
                "index": 2,
                "imgurl": "https://myncut.oss-cn-beijing.aliyuncs.com/Banner/7aaf933cbfaa8ef99a5376b4f20f218.png?x-oss-process=image/auto-orient,1/quality,q_70",
                "msgurl": "https://mp.weixin.qq.com/s/blM2FdhFpXy_rcJWr5bB5g"
            },
            {
                "index": 3,
                "imgurl": "https://myncut.oss-cn-beijing.aliyuncs.com/Banner/WechatIMG470.jpeg?x-oss-process=image/auto-orient,1/quality,q_70",
                "msgurl": "https://mp.weixin.qq.com/s/M7yratKQdZ9yxMDf-yrz3w"
            },
            {
                "index": 4,
                "imgurl": "https://myncut.oss-cn-beijing.aliyuncs.com/Banner/566710ea35fc65929e63927268d2924.png?x-oss-process=image/auto-orient,1/quality,q_70",
                "msgurl": "https://mp.weixin.qq.com/s/8Hro-TB9CwCGtQZUWAxI-Q"
            }
        ],
        "indexNotice": [
            {
                "index": 0,
                "text": "天真的太冷了！裹着被子出门吧！"
            },
            {
                "index": 1,
                "text": "下拉刷新多模式课程"
            },
            {
                "index": 2,
                "text": "2.1.0版本上线！banner推广找我们！"
            }
        ]
    }
}
```

## 🔑用户信息：`/v1/user`

### `GET`获取用户信息

返回完整的用户数据，这个接口只能请求并得到请求者的用户信息。

```json
{
    "code": 200,
    "m": "",
    "data": {
        "sno": "17152010921",
        "sex": "男",
        "nickName": "BBfat",
        "avatarUrl": "https://wx.qlogo.cn/mmopen/vi_32/DYAIOgq83eppGVBbicu6niaOOr2IrkqN9kiaQibqd74xWf1IeuSWoqb9Np5wstDXggMkZsFibwSB4ia7ehCIEiaDbxRtA/132",
        "name": "鞠欣诚",
        "openid": "o1Glo5BZgdDoVqkuXgKzSw_r4T_M",
        "class": "经管17",
        "college": "经济管理学院",
        "source": "山西省"
    }
}
```

## 🔑收藏内容：`/v1/favorites/<type>`

其中`type`是收藏的内容，目前支持：`courseware`课件、`goods`商品。

### `GET`获取收藏夹内容

返回该用户对应类型的收藏夹列表。

* `courseware`

  ```
  
  ```

* `goods`

  ```
  
  ```

### `PUT`增加收藏内容

### `DELETE`删除收藏内容

## 🔑校网数据：`/v1/net`

### `GET`获取校网数据

返回完整的校网数据，这个接口只能请求并得到请求者的用户信息。

```

```

## 🔑多模式课程：`/v1/iclass/course`

### `GET`获取课程列表

```json
{
    "code": 200,
    "m": "",
    "data": [
        {
            "course_name": "数据库原理",
            "course_code": "2019_A_7234801_2019A510025",
            "teacher_name": "",
            "role": "student",
            "course_class": "计17-123;计专起本19"
        },
        {
            "course_name": "操作系统",
            "course_code": "2019_A_7205001_2019A510013",
            "teacher_name": "",
            "role": "student",
            "course_class": "计实验17;计17-123 ;计专起本19"
        },
        {
            "course_name": "Java程序设计",
            "course_code": "2019_S_7002501_2019S510015",
            "teacher_name": "郭峰(计)",
            "role": "student",
            "course_class": "计17-123;计实验17;大数据18"
        }
    ]
}
```

## 🔑多模式课程资料：`/v1/iclass/courseware`

### `GET`获取资料列表

| 参数名称    | 类型   | 备注     |
| ----------- | ------ | -------- |
| course_code | String | 课程代码 |

```json
{
    "code": 200,
    "m": "",
    "data": [
        {
            "url": "http://iclass.ncut.edu.cn/iclass/netclass/backends/download_api.php?url=L8r9vt2%2F4tStwO0tLcq10enWuLW8yumjqDIwMTnE6sfvvL6jqS5uZXSw5rG%2BLmRvYw%3D%3D&cidReset=true&cidReq=2019_A_7234801_2019A510025",
            "type": "file",
            "size": 1751040,
            "date": "2019-11-29",
            "course_code": "2019_A_7234801_2019A510025",
            "filename": "数据库原理--实验指导书（2019年秋季）.net版本.doc",
            "_id": "5e02cea797c32ce21d820563"
        },
        {
            "url": "http://iclass.ncut.edu.cn/iclass/netclass/backends/download_api.php?url=L7XaONXCOC43X8r9vt2%2F4sGsvdO8vMr1LnBwdA%3D%3D&cidReset=true&cidReq=2019_A_7234801_2019A510025",
            "type": "file",
            "size": 1899520,
            "date": "2019-11-29",
            "course_code": "2019_A_7234801_2019A510025",
            "filename": "第8章8.7_数据库连接技术.ppt",
            "_id": "5e02cea797c32ce21d820555"
        },
        {
            "url": "http://iclass.ncut.edu.cn/iclass/netclass/backends/download_api.php?url=L7XaMdXC0PfC2y5wcHQ%3D&cidReset=true&cidReq=2019_A_7234801_2019A510025",
            "type": "file",
            "size": 4470784,
            "date": "2019-09-10",
            "course_code": "2019_A_7234801_2019A510025",
            "filename": "第1章绪论.ppt",
            "_id": "5e02cea797c32ce21d820558"
        }
    ]
}
```

## 🔑下载多模式课件：`/v1/iclass/courseware/download`

### `GET`直接下载

| 参数名称    | 类型   | 备注     |
| ----------- | ------ | -------- |
| course_code | String | 课程代码 |
| filename    | String | 文件名   |

返回文件内容，经测试Chrome可以直接通过这种方式下载。

其中`ResponseHeaders`设置类似如下字段：

`Content-Disposition: attachment;filename=数据库原理--实验指导书（2019年秋季）.net版本.doc`

### `POST`生成公开下载链接

| 参数名称    | 类型   | 备注     |
| ----------- | ------ | -------- |
| course_code | String | 课程代码 |
| filename    | String | 文件名   |

* 正常返回文件id

  ```json
  {
      "code": 200,
      "m": "",
      "data": {
          "id": "5e01a98497c32c30bdf6bb25"
      }
  }
  ```

* 找不到文件

  ```json
  {
      "code": 404,
      "m": "无法找到文件",
      "data": null
  }
  ```

## 🌍通过临时链接下载课件：`/v1/iclass/download`

### `GET`下载

| 参数名称 | 类型   | 备注 |
| -------- | ------ | ---- |
| id       | String |      |

返回文件。